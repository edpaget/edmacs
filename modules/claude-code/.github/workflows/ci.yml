name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ${{ matrix.os }}
    continue-on-error: ${{ matrix.experimental }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        emacs_version:
          - '28.1'
          - '28.2'
          - '29.1'
          - '29.2'
        experimental: [false]
        include:
          # Test on macOS with latest stable
          - os: macos-latest
            emacs_version: '29.2'
            experimental: false
          # Test with Emacs snapshot (allowed to fail)
          - os: ubuntu-latest
            emacs_version: 'snapshot'
            experimental: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Emacs
        uses: purcell/setup-emacs@master
        with:
          version: ${{ matrix.emacs_version }}

      - name: Cache Eldev
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/eldev
            ~/.eldev
          key: ${{ runner.os }}-eldev-${{ hashFiles('**/Eldev') }}
          restore-keys: |
            ${{ runner.os }}-eldev-

      - name: Install Eldev
        run: |
          curl -fsSL https://raw.github.com/emacs-eldev/eldev/master/webinstall/eldev > eldev
          chmod +x eldev
          sudo mv eldev /usr/local/bin/

      - name: Verify Eldev installation
        run: eldev --version

      - name: Install dependencies
        run: eldev -t prepare

      - name: Run demo smoke test
        run: eldev -t demo

      - name: Byte-compile
        run: eldev -dtT compile --warnings-as-errors

      - name: Run tests
        if: hashFiles('test/*.el') != ''
        run: eldev -dtT test

      - name: Run linter
        run: eldev -dtT lint
        continue-on-error: true

  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Emacs
        uses: purcell/setup-emacs@master
        with:
          version: '29.2'

      - name: Cache Eldev
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/eldev
            ~/.eldev
          key: ${{ runner.os }}-eldev-${{ hashFiles('**/Eldev') }}

      - name: Install Eldev
        run: |
          curl -fsSL https://raw.github.com/emacs-eldev/eldev/master/webinstall/eldev > eldev
          chmod +x eldev
          sudo mv eldev /usr/local/bin/

      - name: Build package
        run: eldev -dtT compile

      - name: Check package
        run: eldev -dtT package

  documentation:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check documentation files exist
        run: |
          echo "Checking for documentation..."
          ls -la *.md || true
          test -f README.md || echo "Warning: No README.md found"
          test -f DEVELOPMENT.md || echo "Warning: No DEVELOPMENT.md found"

      - name: Validate markdown
        uses: DavidAnson/markdownlint-cli2-action@v14
        continue-on-error: true
        with:
          globs: '**/*.md'

  report:
    runs-on: ubuntu-latest
    needs: [test, build]
    if: always()

    steps:
      - name: Report status
        run: |
          echo "Test job status: ${{ needs.test.result }}"
          echo "Build job status: ${{ needs.build.result }}"
          if [ "${{ needs.test.result }}" == "failure" ] || [ "${{ needs.build.result }}" == "failure" ]; then
            echo "❌ CI checks failed"
            exit 1
          else
            echo "✅ All CI checks passed"
          fi
