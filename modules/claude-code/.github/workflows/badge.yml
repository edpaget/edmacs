name: Badge

on:
  push:
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday

jobs:
  badge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Emacs
        uses: purcell/setup-emacs@master
        with:
          version: '29.2'

      - name: Install Eldev
        run: |
          curl -fsSL https://raw.github.com/emacs-eldev/eldev/master/webinstall/eldev > eldev
          chmod +x eldev
          sudo mv eldev /usr/local/bin/

      - name: Run checks
        id: checks
        run: |
          set +e
          eldev prepare
          eldev demo
          eldev compile
          STATUS=$?
          if [ $STATUS -eq 0 ]; then
            echo "status=passing" >> $GITHUB_OUTPUT
            echo "color=success" >> $GITHUB_OUTPUT
          else
            echo "status=failing" >> $GITHUB_OUTPUT
            echo "color=critical" >> $GITHUB_OUTPUT
          fi
          exit 0

      - name: Create badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        with:
          auth: ${{ secrets.GIST_SECRET }}
          gistID: YOUR_GIST_ID_HERE
          filename: claude-code-badge.json
          label: build
          message: ${{ steps.checks.outputs.status }}
          color: ${{ steps.checks.outputs.color }}
